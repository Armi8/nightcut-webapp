<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NightCut App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --bg: #0f1014;
            --card-bg: #1a1b1f;
            --text: #ffffff;
            --text-muted: #8e929b;
            --primary: #e50914; /* Ù‚Ø±Ù…Ø² Ù†ØªÙÙ„ÛŒÚ©Ø³ÛŒ */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding-bottom: 50px;
            overflow-x: hidden;
        }

        /* --- Ù†ÙˆØ§Ø± Ø¬Ø³ØªØ¬Ùˆ (Sticky Header) --- */
        .search-area {
            position: sticky; top: 0; z-index: 100;
            background: rgba(15, 16, 20, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .search-wrapper {
            position: relative;
            background: #222;
            border-radius: 12px;
            display: flex; align-items: center;
            border: 1px solid #333;
        }
        .search-input {
            width: 100%; background: transparent; border: none;
            padding: 12px 45px 12px 15px; color: white;
            font-family: inherit; font-size: 14px;
        }
        .search-icon { position: absolute; right: 15px; color: #777; }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø´ØªØ±Ú© Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§ --- */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; margin-top: 25px; margin-bottom: 15px;
        }
        .section-title { 
            font-size: 18px; font-weight: 800; 
            border-right: 3px solid var(--primary); padding-right: 10px;
        }
        .view-all { font-size: 12px; color: var(--text-muted); opacity: 0.8; }

        /* --- Ø§Ø³Ù„Ø§ÛŒØ¯Ø±Ù‡Ø§ÛŒ Ø§ÙÙ‚ÛŒ --- */
        .scroll-container {
            display: flex; gap: 15px; overflow-x: auto;
            padding: 0 20px 10px 20px;
            scroll-snap-type: x mandatory;
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        /* Ú©Ø§Ø±Øª Ø¨Ø²Ø±Ú¯ (Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§) */
        .movie-card-large {
            flex: 0 0 160px; /* Ø¹Ø±Ø¶ Ú©Ø§Ø±Øª */
            position: relative; scroll-snap-align: start;
        }
        .poster-large {
            width: 100%; aspect-ratio: 2/3; border-radius: 16px;
            object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        .rank-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--primary); color: white;
            width: 25px; height: 25px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; border: 2px solid var(--bg);
            z-index: 10;
        }

        /* Ú©Ø§Ø±Øª Ù…Ø¹Ù…ÙˆÙ„ÛŒ (ÙÛŒÙ„Ù… Ùˆ Ø³Ø±ÛŒØ§Ù„) */
        .movie-card-normal {
            flex: 0 0 130px; /* Ø¹Ø±Ø¶ Ú©Ù…ØªØ± */
            position: relative; scroll-snap-align: start;
        }
        .poster-normal {
            width: 100%; aspect-ratio: 2/3; border-radius: 12px;
            object-fit: cover;
        }
        
        /* Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ú©Ø§Ø±Øª */
        .card-meta { margin-top: 8px; }
        .movie-title { 
            font-size: 13px; font-weight: 600; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; 
            direction: ltr; text-align: left;
        }
        .movie-rating { 
            font-size: 11px; color: #ffd700; display: flex; align-items: center; gap: 3px;
        }

        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        .skeleton { background: #222; border-radius: 12px; width: 100%; height: 100%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {opacity: 0.5;} 50% {opacity: 1;} 100% {opacity: 0.5;} }
        .sk-card { aspect-ratio: 2/3; }

    </style>
</head>
<body>

    <div class="search-area">
        <div class="search-wrapper">
            <span class="search-icon"><i class="bi bi-search"></i></span>
            <input type="text" class="search-input" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ ÙÛŒÙ„Ù… ÛŒØ§ Ø³Ø±ÛŒØ§Ù„..." oninput="handleSearch()">
        </div>
    </div>

    <div id="mainContent">
        <div class="section-header">
            <div class="section-title">Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª ğŸ”¥</div>
        </div>
        <div class="scroll-container" id="popularContainer">
            <div class="movie-card-large"><div class="skeleton sk-card"></div></div>
            <div class="movie-card-large"><div class="skeleton sk-card"></div></div>
            <div class="movie-card-large"><div class="skeleton sk-card"></div></div>
        </div>

        <div class="section-header">
            <div class="section-title">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† ÙÛŒÙ„Ù…â€ŒÙ‡Ø§ ğŸ¬</div>
        </div>
        <div class="scroll-container" id="moviesContainer">
            <div class="movie-card-normal"><div class="skeleton sk-card"></div></div>
            <div class="movie-card-normal"><div class="skeleton sk-card"></div></div>
        </div>

        <div class="section-header">
            <div class="section-title">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø³Ø±ÛŒØ§Ù„â€ŒÙ‡Ø§ ğŸ“º</div>
        </div>
        <div class="scroll-container" id="seriesContainer">
            <div class="movie-card-normal"><div class="skeleton sk-card"></div></div>
            <div class="movie-card-normal"><div class="skeleton sk-card"></div></div>
        </div>
    </div>
    
    <div id="searchResults" style="display:none;">
        <div class="section-header"><div class="section-title">Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</div></div>
        <div class="movie-grid" id="searchGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 20px;"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0f1014');

        // ğŸ”¥ğŸ”¥ğŸ”¥ Ù„ÛŒÙ†Ú© Ú©Ù„Ø§Ø¯ÙÙ„Ø± Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨Ø°Ø§Ø± ğŸ”¥ğŸ”¥ğŸ”¥
        const API_URL = "https://baths-differ-yourself-poll.trycloudflare.com";

        async function initApp() {
            try {
                // Ø¯Ø±ÛŒØ§ÙØª Û³ Ø¯Ø³ØªÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ù‡Ù…Ø²Ù…Ø§Ù†
                const [topRes, movieRes, seriesRes] = await Promise.all([
                    fetch(`${API_URL}/api/top`),
                    fetch(`${API_URL}/api/movies?type=movie&page=1`),
                    fetch(`${API_URL}/api/movies?type=series&page=1`)
                ]);

                const topData = await topRes.json();
                const movieData = await movieRes.json();
                const seriesData = await seriesRes.json();

                renderSection('popularContainer', topData, 'large');
                renderSection('moviesContainer', movieData, 'normal');
                renderSection('seriesContainer', seriesData, 'normal');

            } catch (e) { console.error("Error loading data:", e); }
        }

        function renderSection(containerId, data, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯

            if(data.length === 0) {
                container.innerHTML = '<p style="font-size:12px; color:#666; padding:0 20px;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                return;
            }

            data.forEach((m, index) => {
                const card = document.createElement('div');
                // ØªØ´Ø®ÛŒØµ Ú©Ù„Ø§Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ú©Ø§Ø±Øª (Ø¨Ø²Ø±Ú¯ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§ØŒ Ù†Ø±Ù…Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ù‚ÛŒÙ‡)
                card.className = type === 'large' ? 'movie-card-large' : 'movie-card-normal';
                
                card.onclick = () => { 
                    tg.HapticFeedback.impactOccurred('light'); 
                    tg.sendData(m.code); 
                };

                // Ø¨Ø¬ Ø±ØªØ¨Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§ (Û±ØŒ Û²ØŒ Û³ ...)
                const rankHtml = type === 'large' ? `<div class="rank-badge">${index + 1}</div>` : '';
                
                // Ú©Ù„Ø§Ø³ Ù¾ÙˆØ³ØªØ±
                const posterClass = type === 'large' ? 'poster-large' : 'poster-normal';

                card.innerHTML = `
                    <div style="position:relative;">
                        ${rankHtml}
                        <img src="${m.poster}" class="${posterClass}" loading="lazy">
                    </div>
                    <div class="card-meta">
                        <div class="movie-title">${m.title}</div>
                        <div class="movie-rating">
                            <i class="bi bi-star-fill" style="font-size:10px;"></i> ${m.vote}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Ù„Ø§Ø¬ÛŒÚ© Ø¬Ø³ØªØ¬Ùˆ ---
        let searchTimer;
        function handleSearch() {
            const query = document.getElementById('searchInput').value;
            const mainContent = document.getElementById('mainContent');
            const searchResults = document.getElementById('searchResults');
            const searchGrid = document.getElementById('searchGrid');

            clearTimeout(searchTimer);

            if (!query) {
                mainContent.style.display = 'block';
                searchResults.style.display = 'none';
                return;
            }

            searchTimer = setTimeout(async () => {
                mainContent.style.display = 'none';
                searchResults.style.display = 'block';
                searchGrid.innerHTML = '<div class="skeleton sk-card"></div><div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>';

                try {
                    const res = await fetch(`${API_URL}/api/movies?q=${query}`);
                    const data = await res.json();
                    
                    searchGrid.innerHTML = '';
                    if(data.length === 0) {
                        searchGrid.innerHTML = '<p style="color:#aaa;">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                        return;
                    }

                    data.forEach(m => {
                        const div = document.createElement('div');
                        div.innerHTML = `
                             <img src="${m.poster}" style="width:100%; aspect-ratio:2/3; border-radius:10px; object-fit:cover;">
                             <div style="font-size:12px; margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.title}</div>
                        `;
                        div.onclick = () => tg.sendData(m.code);
                        searchGrid.appendChild(div);
                    });

                } catch (e) { console.error(e); }
            }, 600);
        }

        initApp();

    </script>
</body>
</html>
