<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NightCut</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root{
      --bg:#0f1014;
      --card:#15161a;
      --card2:#1a1b1f;
      --text:#fff;
      --muted:#8e929b;
      --line: rgba(255,255,255,0.06);
      --accent:#e11d48;
      --shadow: 0 10px 30px rgba(0,0,0,0.55);
      --radius: 18px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    body{
      margin:0;
      font-family:'Vazirmatn',sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      padding-bottom: 86px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      display:flex;justify-content:space-between;align-items:center;
      padding:20px 20px 10px;
      position:sticky;top:0;z-index:10;
      background:linear-gradient(to bottom, rgba(15,16,20,0.96) 65%, rgba(15,16,20,0.0));
      backdrop-filter: blur(10px);
    }
    .user-profile{display:flex;align-items:center;gap:12px}
    .avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #222;background:#222}
    .welcome-text{font-size:11px;color:var(--muted)}
    .username-text{font-size:16px;font-weight:800}
    .header-actions{display:flex;gap:10px}
    .icon-btn{
      width:40px;height:40px;background:var(--card2);
      border-radius:14px;display:flex;align-items:center;justify-content:center;
      font-size:20px;cursor:pointer;color:white;border:1px solid var(--line);
    }

    .tabs{display:flex;gap:8px;padding: 0 20px 10px;}
    .tab{
      flex:1;background: rgba(255,255,255,0.05);border:1px solid var(--line);
      border-radius: 14px;padding:10px 12px;text-align:center;font-size:12px;color: var(--muted);
      cursor:pointer;user-select:none;
    }
    .tab.active{background: rgba(225,29,72,0.16);border-color: rgba(225,29,72,0.25);color:#fff;font-weight:800;}

    .section-header{
      display:flex;justify-content:space-between;align-items:flex-end;
      padding:0 20px;margin:14px 0 12px;
    }
    .section-title{font-size:20px;font-weight:800}
    .view-all{font-size:12px;color:var(--muted)}

    .scroll-container{display:flex;gap:18px;overflow-x:auto;padding:0 20px 26px;scroll-snap-type:x mandatory;}
    .scroll-container::-webkit-scrollbar{display:none}
    .movie-card-large{flex:0 0 240px;position:relative;scroll-snap-align:center}
    .poster-container{
      width:100%;aspect-ratio:2/3;border-radius:24px;overflow:hidden;position:relative;
      box-shadow:var(--shadow);border:1px solid var(--line);
    }
    .poster-img{width:100%;height:100%;object-fit:cover}
    .poster-overlay{position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,0.95) 12%, transparent 60%);}
    .card-info{position:absolute;bottom:14px;left:14px;right:14px;z-index:2;}
    .movie-title{font-size:18px;font-weight:800;margin-bottom:6px;text-shadow:0 2px 4px #000}
    .rating-row{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:12px;font-weight:800}
    .star{color:#f1c40f}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{padding:4px 10px;border-radius:10px;font-size:10px;font-weight:800;border:1px solid rgba(255,255,255,0.08);background: rgba(255,255,255,0.06);}

    .vertical-list{padding:0 20px;display:flex;flex-direction:column;gap:12px;}
    .movie-card-small{
      display:flex;gap:14px;align-items:center;background:var(--card);
      padding:10px;border-radius:18px;border:1px solid var(--line);cursor:pointer;
    }
    .small-poster{width:72px;height:72px;border-radius:14px;object-fit:cover}
    .small-info{flex:1;min-width:0}
    .small-title{font-size:14px;font-weight:800;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small-meta{font-size:11px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background: rgba(255,255,255,0.06);border:1px solid var(--line);}
    .play-btn-small{
      width:38px;height:38px;background:rgba(255,255,255,0.06);
      border:1px solid var(--line);border-radius:50%;
      display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:18px;
    }

    .btn{
      width:100%;background:rgba(225,29,72,0.14);
      border:1px solid rgba(225,29,72,0.25);color:#fff;border-radius:16px;
      padding:12px 14px;font-weight:900;cursor:pointer;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .load-more-wrap{padding: 14px 20px 30px}

    .skeleton{background:#222;animation:pulse 1.35s infinite;border-radius:inherit}
    @keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}

    /* DETAIL VIEW */
    .page{display:none}
    .page.active{display:block}

    .detail-hero{
      position:relative;
      padding: 0 18px 14px;
    }
    .detail-cover{
      width:100%;
      height: 280px;
      border-radius: 26px;
      overflow:hidden;
      position:relative;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      margin-top: 8px;
    }
    .detail-cover img{width:100%;height:100%;object-fit:cover;filter:saturate(1.05)}
    .detail-cover::after{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(to top, rgba(15,16,20,0.96) 12%, rgba(15,16,20,0.15) 65%, rgba(15,16,20,0.05));
    }
    .detail-topbar{
      display:flex;justify-content:space-between;align-items:center;
      padding: 14px 18px 6px;
    }
    .back-btn{
      width:42px;height:42px;border-radius:16px;
      background:rgba(255,255,255,0.06);border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;cursor:pointer;
    }
    .detail-title{
      font-size:18px;font-weight:900;margin:12px 0 6px;
      padding: 0 6px;
    }
    .detail-meta{
      padding: 0 6px;
      display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;
      margin-bottom: 10px;
    }
    .detail-overview{
      padding: 0 6px;
      color:#d7d7d7;
      font-size:13px;
      line-height: 1.85;
      margin-bottom: 12px;
    }

    .tree-wrap{
      padding: 0 18px 22px;
    }
    .tree-title{
      display:flex;align-items:center;justify-content:space-between;
      margin: 6px 0 10px;
    }
    .tree-title h3{margin:0;font-size:16px}
    .tree-box{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 20px;
      padding: 10px;
    }
    .node{
      display:flex;align-items:center;justify-content:space-between;
      padding: 10px 10px;
      border-radius: 16px;
      cursor:pointer;
    }
    .node:hover{background: rgba(255,255,255,0.04)}
    .node + .node{margin-top: 6px}
    .node-left{display:flex;align-items:center;gap:10px;min-width:0}
    .node-left i{font-size:18px;color: #cfcfcf}
    .node-text{font-size:13px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .node-right{color:var(--muted);font-size:12px}

    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(15,16,20,0.92);border-top:1px solid var(--line);
      backdrop-filter: blur(10px);
      padding: 10px 14px 18px;
      display:flex;gap:10px;justify-content:space-between;z-index:20;
    }
        /* SEARCH UI (RTL-friendly) */
    .search-wrap{
    display:none;
    width:100%;
    padding: 10px 20px 14px;
    }
    .search-wrap.show{ display:block; }

    .search-box{
    position:relative;
    }
    .search-box input{
    width:100%;
    padding: 14px 44px 14px 44px; /* Ø±Ø§Ø³Øª: Ø¢ÛŒÚ©ÙˆÙ†ØŒ Ú†Ù¾: Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† */
    border-radius:16px;
    border:1px solid var(--line);
    background:var(--card);
    color:#fff;
    font-family:inherit;
    }
    .search-ico{
    position:absolute;
    right:14px;
    top:50%;
    transform:translateY(-50%);
    color:var(--muted);
    font-size:18px;
    }
    .clear-btn{
    position:absolute;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    width:34px;
    height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,0.06);
    color: var(--muted);
    display:none;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    }
    .clear-btn.show{ display:flex; }

    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);font-size:11px;cursor:pointer;user-select:none;}
    .nav-item i{font-size:20px}
    .nav-item.active{color:#fff}

  </style>
</head>

<body>

    <!-- Header -->
    <div class="header">
    <div class="user-profile">
        <img src="" class="avatar" id="userAvatar" alt="avatar">
        <div>
        <div class="welcome-text">Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ‘‹</div>
        <div class="username-text" id="userName">Ú©Ø§Ø±Ø¨Ø± Ø¹Ø²ÛŒØ²</div>
        </div>
    </div>

    <div class="header-actions">
        <div class="icon-btn" id="btnSearch" title="Ø¬Ø³ØªØ¬Ùˆ"><i class="bi bi-search"></i></div>
        <div class="icon-btn" id="btnRefresh" title="Ø±ÙØ±Ø´"><i class="bi bi-arrow-repeat"></i></div>
        <div class="icon-btn" id="btnMenu" title="Ù…Ù†Ùˆ"><i class="bi bi-list"></i></div>
    </div>

    <!-- âœ… Search (Ø¯Ø±Ø³Øª Ø¯Ø§Ø®Ù„ header) -->
    <div id="searchContainer" class="search-wrap">
        <div class="search-box">
        <i class="bi bi-search search-ico"></i>
        <input type="text" id="searchInput" placeholder="Ù†Ø§Ù… ÙÛŒÙ„Ù… ÛŒØ§ Ø³Ø±ÛŒØ§Ù„ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
        <button id="btnClearSearch" class="clear-btn" type="button" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†">
            <i class="bi bi-x-lg"></i>
        </button>
        </div>
    </div>
    </div>


  <!-- HOME PAGE -->
  <div id="pageHome" class="page active">

    <div class="tabs">
      <div class="tab active" data-type="">Ù‡Ù…Ù‡</div>
      <div class="tab" data-type="movie">ÙÛŒÙ„Ù…</div>
      <div class="tab" data-type="series">Ø³Ø±ÛŒØ§Ù„</div>
    </div>

    <div class="section-header">
      <div class="section-title">Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§</div>
      <a href="#" class="view-all" id="refreshPopular">Ø±ÙØ±Ø´</a>
    </div>

    <div class="scroll-container" id="popularContainer">
      <div class="movie-card-large"><div class="poster-container"><div class="skeleton" style="width:100%;height:100%"></div></div></div>
      <div class="movie-card-large"><div class="poster-container"><div class="skeleton" style="width:100%;height:100%"></div></div></div>
    </div>

    <div class="section-header">
      <div class="section-title" id="newTitle">ØªØ§Ø²Ù‡â€ŒÙ‡Ø§</div>
      <a href="#" class="view-all" id="refreshNew">Ø±ÙØ±Ø´</a>
    </div>

    <div class="vertical-list" id="newContainer">
      <div class="skeleton" style="height: 86px; border-radius: 18px;"></div>
      <div class="skeleton" style="height: 86px; border-radius: 18px;"></div>
    </div>

    <div class="load-more-wrap">
      <button class="btn" id="btnLoadMore">Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±</button>
    </div>
  </div>

  <!-- DETAIL PAGE -->
  <div id="pageDetail" class="page">
    <div class="detail-topbar">
      <div class="back-btn" id="detailBack"><i class="bi bi-arrow-right"></i></div>
      <div style="color:var(--muted);font-size:12px" id="detailType"></div>
      <div style="width:42px"></div>
    </div>

    <div class="detail-hero">
      <div class="detail-cover" id="detailCover">
        <div class="skeleton" style="width:100%;height:100%"></div>
      </div>

      <div class="detail-title" id="detailTitle">...</div>
      <div class="detail-meta" id="detailMeta"></div>
      <div class="detail-overview" id="detailOverview"></div>
    </div>

    <div class="tree-wrap">
      <div class="tree-title">
        <h3>Ú©ÛŒÙÛŒØªâ€ŒÙ‡Ø§ / ÙØµÙ„â€ŒÙ‡Ø§</h3>
        <div style="color:var(--muted);font-size:12px" id="treeHint"></div>
      </div>
      <div class="tree-box" id="treeBox">
        <div class="skeleton" style="height: 120px; border-radius: 18px;"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item active" id="navHome"><i class="bi bi-house-door"></i><div>Ø®Ø§Ù†Ù‡</div></div>
    <div class="nav-item" id="navTop"><i class="bi bi-fire"></i><div>Ù…Ø­Ø¨ÙˆØ¨â€ŒÙ‡Ø§</div></div>
    <div class="nav-item" id="navNew"><i class="bi bi-clock-history"></i><div>ØªØ§Ø²Ù‡â€ŒÙ‡Ø§</div></div>
    <div class="nav-item" id="navBack"><i class="bi bi-arrow-left-circle"></i><div>Ø¨Ø±Ú¯Ø´Øª</div></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#0f1014');

    // âœ… Ø¢Ø¯Ø±Ø³ API Ø®ÙˆØ¯Øª
    const urlParams = new URLSearchParams(window.location.search);
    
    // Û². Ú¯Ø±ÙØªÙ† Ø¢Ø¯Ø±Ø³ API Ø§Ø² Ù¾Ø§Ø±Ø§Ù…ØªØ± 'api'
    // Ø§Ú¯Ø± Ø±Ø¨Ø§Øª Ù„ÛŒÙ†Ú©ÛŒ Ù†Ø¯Ø§Ø¯ØŒ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (ØªØ³Øª Ù„ÙˆÚ©Ø§Ù„) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    const API_URL = urlParams.get('api') || "http://127.0.0.1:8000";

    // Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ (ØªÙˆ Ú©Ù†Ø³ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø± Ù†Ø´ÙˆÙ† Ù…ÛŒØ¯Ù‡ Ø¨Ù‡ Ú©Ø¬Ø§ ÙˆØµÙ„ Ø´Ø¯Ù‡)
    console.log("Connected to API:", API_URL);

    // ğŸ‘†ğŸ‘†ğŸ‘† Ù¾Ø§ÛŒØ§Ù† ØªØºÛŒÛŒØ±Ø§Øª ğŸ‘†ğŸ‘†ğŸ‘†

    // state
    let currentType = "";
    let currentPage = 1;
    const limit = 12;
    let totalPages = 1;
    let loadingMore = false;

    // detail state
    let detailStack = []; // Ø¨Ø±Ø§ÛŒ Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† Ø¯Ø§Ø®Ù„ tree (folder Ù‡Ø§)
    let currentDetailCode = null;

    function safeText(s) {
      return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    // ğŸ” Search Logic (FIXED + Better UI)
let searchTimeout;
let isSearching = false;

const searchWrap = document.getElementById('searchContainer');
const searchInput = document.getElementById('searchInput');
const btnClearSearch = document.getElementById('btnClearSearch');

function setSearchUI(open){
  searchWrap.classList.toggle('show', open);
  if(open){
    searchInput.focus();
  } else {
    searchInput.value = "";
    btnClearSearch.classList.remove('show');
    exitSearchMode();
  }
}

function enterSearchMode(q){
  isSearching = true;
  document.getElementById('btnLoadMore').style.display = 'none';
  const titleEl = document.getElementById('newTitle');
  titleEl.innerHTML = `Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ: <span style="color:var(--accent)">${safeText(q)}</span>`;
}

function exitSearchMode(){
  isSearching = false;
  document.getElementById('btnLoadMore').style.display = 'block';
  document.getElementById('newTitle').innerText = "ØªØ§Ø²Ù‡â€ŒÙ‡Ø§";
  fetchNew(true);
}

// Ø¯Ú©Ù…Ù‡ Ø³Ø±Ú†: Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡
document.getElementById('btnSearch').addEventListener('click', () => {
  haptic('light');
  const open = !searchWrap.classList.contains('show');
  setSearchUI(open);
});

// Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ¹
btnClearSearch.addEventListener('click', () => {
  haptic('light');
  searchInput.value = "";
  btnClearSearch.classList.remove('show');
  exitSearchMode();
  searchInput.focus();
});

// ØªØ§ÛŒÙ¾ Ø¨Ø§ debounce
searchInput.addEventListener('input', (e) => {
  const q = e.target.value.trim();
  btnClearSearch.classList.toggle('show', q.length > 0);

  clearTimeout(searchTimeout);

  if(q.length === 0){
    exitSearchMode();
    return;
  }

  searchTimeout = setTimeout(() => performSearch(q), 450);
});

// Enter Ø¨Ø±Ø§ÛŒ Ø³Ø±Ú† Ø³Ø±ÛŒØ¹
searchInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    const q = searchInput.value.trim();
    if(q){
      clearTimeout(searchTimeout);
      performSearch(q);
    }
  }
});

async function performSearch(q){
  enterSearchMode(q);

  const container = document.getElementById('newContainer');
  container.innerHTML = `
    <div class="skeleton" style="height: 86px; border-radius: 18px;"></div>
    <div class="skeleton" style="height: 86px; border-radius: 18px;"></div>
  `;

  try{
    const url = new URL(`${API_URL}/api/movies`);
    url.searchParams.set("q", q);
    url.searchParams.set("limit", 20);
    if(currentType) url.searchParams.set("type", currentType); // ÙÛŒÙ„ØªØ± ØªØ¨â€ŒÙ‡Ø§ Ø±ÙˆÛŒ Ø³Ø±Ú† Ù‡Ù… Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒØ´Ù‡

    const res = await fetch(url.toString());
    const data = await res.json();

    renderNew(data.items || []);
  } catch(e){
    console.error(e);
    container.innerHTML = `<div style="color:var(--muted);font-size:12px;padding:6px 2px">Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ.</div>`;
  }
}


    function setupUser() {
      let avatarUrl = "https://ui-avatars.com/api/?name=Guest&background=111827&color=fff";
      let name = "Ú©Ø§Ø±Ø¨Ø± Ø¹Ø²ÛŒØ²";
      if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const u = tg.initDataUnsafe.user;
        name = u.first_name + (u.last_name ? " " + u.last_name : "");
        avatarUrl = u.photo_url ? u.photo_url : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=111827&color=fff`;
      }
      document.getElementById('userName').innerText = name;
      document.getElementById('userAvatar').src = avatarUrl;
    }

    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function haptic(type='light'){
      try { tg.HapticFeedback.impactOccurred(type); } catch(e){}
    }

    // ===== HOME RENDER =====
    function renderPopular(movies) {
      const container = document.getElementById('popularContainer');
      container.innerHTML = "";
      if (!movies || !movies.length) {
        container.innerHTML = `<div style="padding:0 20px;color:var(--muted);font-size:12px">Ú†ÛŒØ²ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>`;
        return;
      }
      movies.forEach(m => {
        const [g1,g2] = pickGenres(m.genres);
        const card = document.createElement('div');
        card.className = 'movie-card-large';
        card.onclick = () => openDetail(m.code);
        card.innerHTML = `
          <div class="poster-container">
            <img src="${m.poster}" class="poster-img" loading="lazy" alt="${safeText(m.title)}">
            <div class="poster-overlay"></div>
            <div class="card-info">
              <div class="movie-title">${safeText(m.title)}</div>
              <div class="rating-row">
                <span class="star"><i class="bi bi-star-fill"></i></span>
                <span>${m.vote ?? 0}</span>
                ${m.year ? `<span style="color:var(--muted);font-weight:700">â€¢ ${safeText(m.year)}</span>` : ``}
              </div>
              <div class="tags">
                <span class="tag">${safeText(g1)}</span>
                <span class="tag">${safeText(g2)}</span>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderNew(items, append=false) {
      const container = document.getElementById('newContainer');
      if (!append) container.innerHTML = "";
      if (!items || !items.length) {
        if (!append) container.innerHTML = `<div style="color:var(--muted);font-size:12px;padding:6px 2px">Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>`;
        return;
      }
      items.forEach(m => {
        const [g1,g2] = pickGenres(m.genres);
        const card = document.createElement('div');
        card.className = 'movie-card-small';
        card.onclick = () => openDetail(m.code);
        card.innerHTML = `
          <img src="${m.poster}" class="small-poster" loading="lazy" alt="${safeText(m.title)}">
          <div class="small-info">
            <div class="small-title">${safeText(m.title)}</div>
            <div class="small-meta">
              <span class="chip"><i class="bi bi-star-fill" style="color:#f1c40f"></i> ${m.vote ?? 0}</span>
              ${m.year ? `<span class="chip"><i class="bi bi-calendar3"></i> ${safeText(m.year)}</span>` : ``}
              <span class="chip"><i class="bi bi-tags"></i> ${safeText(g1)}</span>
              <span class="chip"><i class="bi bi-badge-hd"></i> ${safeText(g2)}</span>
            </div>
          </div>
          <div class="play-btn-small"><i class="bi bi-play-fill"></i></div>
        `;
        container.appendChild(card);
      });
    }

    async function fetchPopular() {
      try {
        const res = await fetch(`${API_URL}/api/top?limit=10`);
        const data = await res.json();
        renderPopular(data);
      } catch (e) { console.error(e); }
    }

    async function fetchNew(reset=true) {
      try {
        if (reset) {
          currentPage = 1;
          loadingMore = false;
          document.getElementById('btnLoadMore').disabled = true;
          document.getElementById('newContainer').innerHTML = `
            <div class="skeleton" style="height: 86px; border-radius: 18px;"></div>
            <div class="skeleton" style="height: 86px; border-radius: 18px;"></div>
          `;
        }

        const url = new URL(`${API_URL}/api/movies`);
        url.searchParams.set("page", String(currentPage));
        url.searchParams.set("limit", String(limit));
        if (currentType) url.searchParams.set("type", currentType);

        const res = await fetch(url.toString());
        const data = await res.json();
        totalPages = data.total_pages || 1;

        renderNew(data.items || [], !reset);

        const btn = document.getElementById('btnLoadMore');
        btn.disabled = (currentPage >= totalPages);
        btn.innerText = (currentPage >= totalPages) ? "Ù¾Ø§ÛŒØ§Ù† Ù„ÛŒØ³Øª" : "Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±";
      } catch (e) { console.error(e); }
    }

    async function loadMore() {
      if (loadingMore) return;
      if (currentPage >= totalPages) return;
      loadingMore = true;
      currentPage += 1;
      await fetchNew(false);
      loadingMore = false;
    }

    function setActiveTab(type) {
      currentType = type;
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.type === type));
      const title = document.getElementById('newTitle');
      title.innerText = type === "movie" ? "ØªØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„Ù…" : type === "series" ? "ØªØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ§Ù„" : "ØªØ§Ø²Ù‡â€ŒÙ‡Ø§";
      fetchNew(true);
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => setActiveTab(tab.dataset.type));
    });

    document.getElementById('refreshPopular').addEventListener('click', (e) => { e.preventDefault(); fetchPopular(); });
    document.getElementById('refreshNew').addEventListener('click', (e) => { e.preventDefault(); fetchNew(true); });
    document.getElementById('btnLoadMore').addEventListener('click', loadMore);

    // ===== DETAIL VIEW =====
    async function openDetail(code){
      haptic('medium');
      currentDetailCode = code;
      detailStack = []; // reset navigation stack
      showPage('pageDetail');

      // skeleton
      document.getElementById('detailCover').innerHTML = `<div class="skeleton" style="width:100%;height:100%"></div>`;
      document.getElementById('detailTitle').innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
      document.getElementById('detailMeta').innerHTML = "";
      document.getElementById('detailOverview').innerText = "";
      document.getElementById('treeBox').innerHTML = `<div class="skeleton" style="height: 120px; border-radius: 18px;"></div>`;
      document.getElementById('treeHint').innerText = "";

      try{
        const [cRes, tRes] = await Promise.all([
          fetch(`${API_URL}/api/content/${code}`),
          fetch(`${API_URL}/api/content/${code}/tree`)
        ]);
        const content = await cRes.json();
        const treePayload = await tRes.json();

        // render content
        document.getElementById('detailCover').innerHTML = `<img src="${content.poster}" alt="${safeText(content.title)}">`;
        document.getElementById('detailTitle').innerText = content.title;

        const typeText = content.type === 'series' ? 'Ø³Ø±ÛŒØ§Ù„' : 'ÙÛŒÙ„Ù…';
        document.getElementById('detailType').innerText = typeText;

        let meta = `
          <span class="chip"><i class="bi bi-star-fill" style="color:#f1c40f"></i> ${content.vote ?? 0}</span>
          ${content.year ? `<span class="chip"><i class="bi bi-calendar3"></i> ${safeText(content.year)}</span>` : ``}
        `;
        if (content.genres) meta += `<span class="chip"><i class="bi bi-tags"></i> ${safeText(content.genres.split(",")[0] || "")}</span>`;
        document.getElementById('detailMeta').innerHTML = meta;

        const ov = (content.overview || "").trim();
        document.getElementById('detailOverview').innerText = ov ? ov : "Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.";

        // store root nodes
        detailStack = [{ title: "Ø±ÛŒØ´Ù‡", nodes: treePayload.tree || [] }];
        renderTreeLevel();

      }catch(e){
        console.error(e);
        document.getElementById('treeBox').innerHTML = `<div style="color:var(--muted);font-size:12px;padding:10px">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±.</div>`;
      }
    }

    function renderTreeLevel(){
      const box = document.getElementById('treeBox');
      const hint = document.getElementById('treeHint');
      const level = detailStack[detailStack.length - 1];
      const nodes = level.nodes || [];

      hint.innerText = detailStack.length > 1 ? `Ø³Ø·Ø­ ${detailStack.length-1}` : "";

      if (!nodes.length){
        box.innerHTML = `<div style="color:var(--muted);font-size:12px;padding:10px">Ú†ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>`;
        return;
      }

      box.innerHTML = "";

      // Ø§Ú¯Ø± Ø¯Ø§Ø®Ù„ ÙÙˆÙ„Ø¯Ø± Ù‡Ø³ØªÛŒÙ…ØŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø®Ù„ Ø¨Ø§Ú©Ø³ Ù‡Ù… Ø¨Ø¯Ù‡
      if (detailStack.length > 1){
        const backNode = document.createElement('div');
        backNode.className = "node";
        backNode.onclick = () => { haptic('light'); detailStack.pop(); renderTreeLevel(); };
        backNode.innerHTML = `
          <div class="node-left">
            <i class="bi bi-arrow-right"></i>
            <div class="node-text">Ø¨Ø§Ø²Ú¯Ø´Øª</div>
          </div>
          <div class="node-right">..</div>
        `;
        box.appendChild(backNode);
      }

      nodes.forEach(n => {
        const isFolder = n.media_type === "folder";
        const nodeEl = document.createElement('div');
        nodeEl.className = "node";
        nodeEl.onclick = () => {
          if (isFolder){
            haptic('light');
            detailStack.push({ title: n.text, nodes: n.children || [] });
            renderTreeLevel();
          } else {
            // âœ… Ø¯Ø§Ù†Ù„ÙˆØ¯: variation_id Ø¨Ù‡ Ø±Ø¨Ø§Øª
            haptic('medium');
            tg.sendData(`GET:${n.id}`);
          }
        };

        nodeEl.innerHTML = `
          <div class="node-left">
            <i class="bi ${isFolder ? 'bi-folder2-open' : 'bi-download'}"></i>
            <div class="node-text">${safeText(n.text)}</div>
          </div>
          <div class="node-right">${isFolder ? 'Ø¨Ø§Ø² Ú©Ù†' : 'Ø¯Ø§Ù†Ù„ÙˆØ¯'}</div>
        `;
        box.appendChild(nodeEl);
      });
    }

    document.getElementById('detailBack').addEventListener('click', () => {
      haptic('light');
      showPage('pageHome');
      currentDetailCode = null;
      detailStack = [];
    });

    // ===== Bottom nav =====
    function setNavActive(id) {
      document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    document.getElementById('navHome').addEventListener('click', () => {
      setNavActive('navHome');
      showPage('pageHome');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    document.getElementById('navTop').addEventListener('click', () => {
      setNavActive('navTop');
      showPage('pageHome');
      document.querySelector('#popularContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    document.getElementById('navNew').addEventListener('click', () => {
      setNavActive('navNew');
      showPage('pageHome');
      document.querySelector('#newContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    document.getElementById('navBack').addEventListener('click', () => {
      haptic('light');
      if (document.getElementById('pageDetail').classList.contains('active')){
        showPage('pageHome');
        currentDetailCode = null;
        detailStack = [];
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    // Header buttons
    document.getElementById('btnRefresh').addEventListener('click', () => {
      haptic('light');
      fetchPopular();
      fetchNew(true);
    });

    document.getElementById('btnMenu').addEventListener('click', () => {
      haptic('light');
      tg.showPopup({
        title: "NightCut",
        message: "Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª / Ø±Ø§Ù‡Ù†Ù…Ø§ / Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ.",
        buttons: [{ id: "ok", type: "ok", text: "Ø¨Ø§Ø´Ù‡" }]
      });
    });

    // Init
    setupUser();
    fetchPopular();
    fetchNew(true);
  </script>
</body>
</html>
