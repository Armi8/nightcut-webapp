<!doctype html>
<html lang="fa" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>NightCut</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0c10;
      --card:#12131a;
      --text:#ffffff;
      --muted:#a6aab6;
      --line: rgba(255,255,255,0.08);
      --accent:#a855f7;
      --accent2:#6d28d9;
      --radius: 20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Vazirmatn', sans-serif; /* تغییر فونت */
      color:var(--text);
      background: #0b0c10;
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    
    /* Icons SVG Styles */
    .icon {
        width: 24px; height: 24px;
        fill: none;
        stroke: white;
        stroke-width: 1.5;
        stroke-linecap: round;
        stroke-linejoin: round;
    }
    .icon-sm { width: 18px; height: 18px; }

    .app{
      max-width: 430px; margin: 0 auto; min-height: 100vh;
      padding: 14px 14px 100px; position: relative;
    }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 8px 4px 12px;
    }
    .hello{ display:flex; align-items:center; gap:10px; }
    .avatar{
      width:36px; height:36px; border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid; place-items:center; font-weight:800; font-size:14px;
    }
    .hello .meta .hi{font-size:11px; color:var(--muted)}
    .hello .meta .name{font-size:14px; font-weight:700}
    
    .iconbtn{
      width:38px; height:38px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.03);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .iconbtn:active{transform:scale(.95)}

    /* --- CAROUSEL (SLIDER) --- */
    .carouselWrap {
        margin-top: 10px;
        border-radius: var(--radius);
        overflow: hidden;
        position: relative;
        height: 200px; /* ارتفاع بنر */
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        border: 1px solid var(--line);
    }
    .carouselTrack {
        display: flex;
        height: 100%;
        transition: transform 0.5s ease-in-out;
    }
    .slide {
        min-width: 100%;
        height: 100%;
        position: relative;
    }
    .slide img {
        width: 100%; height: 100%; object-fit: cover;
        filter: brightness(0.6);
    }
    .slideContent {
        position: absolute; bottom: 0; left: 0; right: 0;
        padding: 60px 16px 16px;
        background: linear-gradient(to top, rgba(11,12,16,1) 0%, rgba(11,12,16,0) 100%);
        color: white;
    }
    .slideTitle {
        font-size: 18px; font-weight: 800; margin-bottom: 4px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    .slideMeta {
        font-size: 12px; color: #d1d5db; display: flex; gap: 8px; align-items: center;
    }
    .slideBadge {
        background: var(--accent); color: white; padding: 2px 8px; 
        border-radius: 6px; font-size: 10px; font-weight: 700;
    }

    /* Sections */
    .section{ margin-top: 24px; }
    .sectionHead{
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 4px 10px;
    }
    .sectionHead h3{ margin:0; font-size: 15px; font-weight: 800; }
    .seeAll{ font-size: 12px; color: var(--muted); cursor:pointer; }

    /* Horizontal Scroll */
    .hscroll{
      display:flex; gap:12px; overflow-x:auto; padding: 4px 2px 12px;
      scrollbar-width:none;
    }
    .hscroll::-webkit-scrollbar{display:none}

    /* Cards */
    .card{
      flex:0 0 auto; width: 130px;
      cursor:pointer;
    }
    .card .poster{
      width:100%; aspect-ratio: 2/3;
      border-radius: 16px; overflow:hidden;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      position: relative;
    }
    .card .poster img{width:100%; height:100%; object-fit:cover; display:block}
    .card .title{
      font-size: 12px; font-weight: 700; margin: 8px 0 4px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .card .meta{ font-size: 10px; color: var(--muted); }

    /* Bottom Nav (Improved Glass) */
    .bottomNav{
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      width: min(400px, calc(100% - 32px));
      background: rgba(18, 19, 26, 0.65); /* شفاف تر */
      backdrop-filter: blur(20px); /* بلور قوی تر */
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px;
      padding: 12px 20px;
      display:flex; justify-content:space-between; align-items:center;
      z-index: 100;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    }
    .navItem{
      display:flex; flex-direction:column; align-items:center; gap:4px;
      color: var(--muted); cursor:pointer;
    }
    .navItem.active{ color: white; }
    .navItem.active .icon { stroke: var(--accent); stroke-width: 2; }

    /* Search Input */
    .searchWrap{
      margin-top: 16px;
      display:flex; align-items:center; gap:10px;
      padding: 12px; border-radius: 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--line);
    }
    .searchWrap input{
      width:100%; border:0; background:transparent; outline:none;
      color:white; font-family: 'Vazirmatn'; font-size:14px;
    }

    /* Details Page */
    .page{ display:none; animation: fadein 0.3s ease; }
    .page.active{ display:block; }
    @keyframes fadein { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    
    .detailsHero{
        border-radius: var(--radius); overflow: hidden;
        position: relative; height: 320px;
    }
    .detailsHero img.bg{ width: 100%; height: 100%; object-fit: cover; }
    .detailsOverlay{
        position: absolute; inset: 0;
        background: linear-gradient(to top, #0b0c10 10%, transparent 80%);
        display: flex; flex-direction: column; justify-content: flex-end;
        padding: 20px;
    }
    
    .storyline{ 
        background: #12131a; padding: 16px; border-radius: 16px; margin-top: 16px;
        border: 1px solid var(--line);
    }
    .tree{ margin-top: 16px; }
    .node{ 
        background: #12131a; border: 1px solid var(--line); 
        padding: 12px; border-radius: 12px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: center;
    }

    /* Toast */
    .toast{
      position: fixed; bottom: 100px; left:50%; transform:translateX(-50%);
      background: #222; padding: 10px 20px; border-radius: 30px;
      font-size: 12px; display:none; z-index:200; border:1px solid #333;
    }
  </style>
</head>

<body>
  <div class="app">

    <section id="page-home" class="page active">
      <div class="topbar">
        <div class="hello">
          <div class="avatar" id="avatar">N</div>
          <div class="meta">
            <div class="hi">Welcome Back</div>
            <div class="name" id="tgName">NightCut User</div>
          </div>
        </div>
        <div class="iconbtn">
           <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        </div>
      </div>

      <div class="searchWrap">
        <svg class="icon icon-sm" style="opacity:0.5" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input id="searchInput" placeholder="Search movies..." autocomplete="off" />
      </div>

      <div class="carouselWrap">
        <div class="carouselTrack" id="carouselTrack">
            <div class="slide" style="display:grid; place-items:center; color:#555">Loading...</div>
        </div>
      </div>

      <div class="section">
        <div class="sectionHead">
          <h3>Latest Movies</h3>
          <div class="seeAll" onclick="showToast('Use search')">View All</div>
        </div>
        <div class="hscroll" id="moviesRow">
           </div>
      </div>

      <div class="section">
        <div class="sectionHead">
          <h3>Latest Series</h3>
          <div class="seeAll" onclick="showToast('Use search')">View All</div>
        </div>
        <div class="hscroll" id="seriesRow">
           </div>
      </div>

    </section>

    <section id="page-details" class="page">
        <div class="topbar">
            <div class="iconbtn" id="backHome">
                <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </div>
            <div style="font-weight:800">Details</div>
            <div class="iconbtn" id="saveBtn">
                <svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
            </div>
        </div>

        <div class="detailsHero">
            <img src="" class="bg" id="dPoster" />
            <div class="detailsOverlay">
                <div class="slideBadge" id="dType" style="align-self: flex-start; margin-bottom:8px">MOVIE</div>
                <h1 id="dTitle" style="margin:0; font-size:22px; font-weight:900">Title</h1>
                <div style="font-size:12px; opacity:0.8; margin-top:4px" id="dMeta">2024 • Genre</div>
            </div>
        </div>

        <div class="storyline">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px">STORYLINE</div>
            <div id="dPlot" style="font-size:13px; line-height:1.6">...</div>
        </div>

        <div class="tree" id="dFiles">
            </div>
    </section>

    <div class="toast" id="toast">Alert</div>

  </div>

  <nav class="bottomNav">
    <div class="navItem active" id="navHome">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </div>
    <div class="navItem" id="navSearch">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    </div>
    <div class="navItem" id="navSave">
        <svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
    </div>
    <div class="navItem">
        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    </div>
  </nav>

<script>
const API_BASE = (new URLSearchParams(location.search).get("api") || "").replace(/\/+$/, "");
const api = p => API_BASE ? API_BASE + p : p;
const tg = window.Telegram?.WebApp;
if(tg){ tg.ready(); tg.expand(); tg.setHeaderColor?.("#0b0c10"); tg.setBackgroundColor?.("#0b0c10"); }

// Data
let topItems = [];

// Elements
const els = {
    home: document.getElementById('page-home'),
    details: document.getElementById('page-details'),
    track: document.getElementById('carouselTrack'),
    moviesRow: document.getElementById('moviesRow'),
    seriesRow: document.getElementById('seriesRow'),
    dTitle: document.getElementById('dTitle'),
    dPoster: document.getElementById('dPoster'),
    dPlot: document.getElementById('dPlot'),
    dType: document.getElementById('dType'),
    dMeta: document.getElementById('dMeta'),
    dFiles: document.getElementById('dFiles'),
    toast: document.getElementById('toast'),
    searchInput: document.getElementById('searchInput')
};

// --- INIT ---
async function init(){
    // Set User Name
    if(tg?.initDataUnsafe?.user) {
        document.getElementById('tgName').textContent = tg.initDataUnsafe.user.first_name;
        document.getElementById('avatar').textContent = tg.initDataUnsafe.user.first_name[0];
    }

    try {
        const [topData, moviesData, seriesData] = await Promise.all([
            fetch(api('/api/top?limit=8')).then(r=>r.json()),
            fetch(api('/api/movies?type=movie&limit=10')).then(r=>r.json()),
            fetch(api('/api/movies?type=series&limit=10')).then(r=>r.json())
        ]);

        topItems = Array.isArray(topData) ? topData : [];
        initCarousel(topItems);
        
        renderRow(els.moviesRow, moviesData.items || []);
        renderRow(els.seriesRow, seriesData.items || []);

    } catch(e) {
        showToast("Error loading data");
        console.error(e);
    }
}

// --- CAROUSEL LOGIC ---
let slideIndex = 0;
function initCarousel(items){
    if(!items.length) return;
    
    // Create slides + Clone first slide for infinite effect
    const all = [...items, items[0]]; 
    
    els.track.innerHTML = all.map((item, idx) => `
        <div class="slide" onclick="openDetails('${item.code}')">
            <img src="${item.poster}" loading="lazy" />
            <div class="slideContent">
                <div class="slideTitle">${item.title}</div>
                <div class="slideMeta">
                   <span class="slideBadge">${item.type === 'series'?'SERIES':'MOVIE'}</span>
                   <span>${item.year}</span>
                   <span>★ ${item.vote}</span>
                </div>
            </div>
        </div>
    `).join('');

    // Auto Loop
    setInterval(() => {
        slideIndex++;
        updateCarousel();
    }, 4000); // 4 seconds
}

function updateCarousel(){
    const width = els.track.clientWidth;
    els.track.style.transition = "transform 0.5s ease-in-out";
    els.track.style.transform = `translateX(-${slideIndex * 100}%)`;

    // Infinite Loop Reset
    if(slideIndex >= topItems.length){
        setTimeout(() => {
            els.track.style.transition = "none";
            slideIndex = 0;
            els.track.style.transform = `translateX(0)`;
        }, 500);
    }
}

// --- RENDERING ---
function renderRow(container, items){
    container.innerHTML = items.map(item => `
        <div class="card" onclick="openDetails('${item.code}')">
            <div class="poster"><img src="${item.poster}" loading="lazy"/></div>
            <div class="title">${item.title}</div>
            <div class="meta">${item.year} • ★ ${item.vote}</div>
        </div>
    `).join('');
}

// --- DETAILS ---
async function openDetails(code){
    els.home.classList.remove('active');
    els.details.classList.add('active');
    window.scrollTo(0,0);
    
    // Skeleton/Loading state
    els.dTitle.textContent = "Loading...";
    els.dFiles.innerHTML = "<div style='color:#777; padding:10px'>Loading files...</div>";

    try {
        const data = await fetch(api(`/api/content/${code}`)).then(r=>r.json());
        const tree = await fetch(api(`/api/content/${code}/tree`)).then(r=>r.json());

        els.dPoster.src = data.poster;
        els.dTitle.textContent = data.title;
        els.dType.textContent = data.type.toUpperCase();
        els.dMeta.textContent = `${data.year} • ${data.genres} • ★ ${data.vote}`;
        els.dPlot.textContent = data.overview;
        
        renderFiles(tree.tree || []);

    } catch(e) { showToast("Error opening details"); }
}

function renderFiles(nodes){
    if(!nodes.length) { els.dFiles.innerHTML = "<div style='padding:10px; font-size:12px; color:gray'>No files.</div>"; return; }
    
    els.dFiles.innerHTML = nodes.map(n => {
        const isFolder = n.media_type === 'folder';
        const icon = isFolder ? 
            '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>' : 
            '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
        
        return `
        <div class="node" onclick="${isFolder ? '' : `sendToBot('${n.id}')`}">
            <div style="display:flex; align-items:center; gap:10px; overflow:hidden">
                <div style="opacity:0.7">${icon}</div>
                <div style="font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${n.text}</div>
            </div>
            ${!isFolder ? '<div style="font-size:10px; opacity:0.5">GET</div>' : ''}
        </div>
        `;
    }).join('');
}

function sendToBot(id){
    if(tg?.sendData) tg.sendData(`GET:${id}`);
    showToast("Sent to bot");
}

function showToast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    setTimeout(()=> els.toast.style.display="none", 2000);
}

// Nav events
document.getElementById('backHome').onclick = () => {
    els.details.classList.remove('active');
    els.home.classList.add('active');
};
document.getElementById('navHome').onclick = () => {
    els.details.classList.remove('active');
    els.home.classList.add('active');
    document.querySelectorAll('.navItem').forEach(i=>i.classList.remove('active'));
    document.getElementById('navHome').classList.add('active');
};
document.getElementById('navSearch').onclick = () => els.searchInput.focus();

// Search
els.searchInput.addEventListener('keydown', async (e) => {
    if(e.key === 'Enter'){
        const q = els.searchInput.value;
        if(!q) return init();
        
        els.moviesRow.innerHTML = "Searching...";
        els.seriesRow.innerHTML = "";
        
        const res = await fetch(api(`/api/movies?q=${q}&limit=20`)).then(r=>r.json());
        renderRow(els.moviesRow, res.items || []);
    }
});

// Start
init();
</script>
</body>
</html>
