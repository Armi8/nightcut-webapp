<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NightCut</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root{
      --bg:#0f1014; --card:#15161a; --card2:#1a1b1f; --text:#fff;
      --muted:#8e929b; --line: rgba(255,255,255,0.06); --accent:#e11d48;
      --shadow: 0 10px 30px rgba(0,0,0,0.55); --radius: 18px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    body{margin:0;font-family:'Vazirmatn',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;padding-bottom:86px}
    a{color:inherit;text-decoration:none}

    /* HEADER */
    .header{display:flex;justify-content:space-between;align-items:center;padding:20px 20px 10px;position:sticky;top:0;z-index:10;background:rgba(15,16,20,0.95);backdrop-filter:blur(10px)}
    .user-profile{display:flex;align-items:center;gap:12px}
    .avatar{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid #222;background:#222}
    .welcome-text{font-size:10px;color:var(--muted)}
    .username-text{font-size:14px;font-weight:800}
    .header-actions{display:flex;gap:8px}
    .icon-btn{width:38px;height:38px;background:var(--card2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;color:white;border:1px solid var(--line)}

    /* SEARCH */
    .search-wrap{display:none;width:100%;padding:0 20px 10px;position:sticky;top:70px;z-index:9;background:var(--bg)}
    .search-wrap.show{display:block}
    .search-box{position:relative}
    .search-box input{width:100%;padding:12px 40px 12px 14px;border-radius:14px;border:1px solid var(--line);background:var(--card);color:#fff;font-family:inherit;font-size:14px}
    .search-ico{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    
    /* SECTIONS */
    .home-content {transition: opacity 0.3s}
    .home-content.hidden {display: none}
    
    .section-header{display:flex;justify-content:space-between;align-items:center;padding:0 20px;margin:20px 0 12px}
    .section-title{font-size:16px;font-weight:800;border-right:3px solid var(--accent);padding-right:8px}
    
    /* HORIZONTAL SCROLL */
    .scroll-container{display:flex;gap:14px;overflow-x:auto;padding:0 20px 10px;scroll-snap-type:x mandatory}
    .scroll-container::-webkit-scrollbar{display:none}
    .movie-card-large{flex:0 0 140px;position:relative;scroll-snap-align:start}
    .poster-container{width:100%;aspect-ratio:2/3;border-radius:16px;overflow:hidden;position:relative;margin-bottom:8px}
    .poster-img{width:100%;height:100%;object-fit:cover}
    .card-rating{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);padding:2px 6px;border-radius:6px;font-size:10px;font-weight:bold;color:#f1c40f;display:flex;gap:3px;align-items:center}
    .movie-title-scroll{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700}

    /* VERTICAL LIST */
    .vertical-list{padding:0 20px;display:flex;flex-direction:column;gap:10px}
    .movie-card-small{display:flex;gap:12px;align-items:center;background:var(--card);padding:8px;border-radius:14px;border:1px solid var(--line)}
    .small-poster{width:60px;height:60px;border-radius:10px;object-fit:cover}
    .small-info{flex:1;min-width:0}
    .small-title{font-size:13px;font-weight:800;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small-meta{font-size:10px;color:var(--muted);display:flex;gap:8px}
    .chip{display:inline-flex;gap:4px;align-items:center;background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:6px}

    /* LOAD MORE */
    .btn{width:100%;background:var(--card2);border:1px solid var(--line);color:var(--muted);border-radius:14px;padding:12px;font-size:12px;margin-top:20px}
    
    /* DETAIL PAGE & OTHERS (Simplified from previous) */
    .page{display:none} .page.active{display:block}
    .detail-hero{position:relative}
    .detail-cover{height:300px;position:relative}
    .detail-cover img{width:100%;height:100%;object-fit:cover;mask-image:linear-gradient(to bottom, black 60%, transparent 100%)}
    .detail-info{padding:20px;margin-top:-60px;position:relative;z-index:2}
    .d-title{font-size:22px;font-weight:900;margin-bottom:10px;text-shadow:0 2px 10px rgba(0,0,0,0.8)}
    .d-overview{font-size:12px;color:#ccc;line-height:1.6;margin-bottom:20px}
    .tree-box{padding:20px}
    .node{background:var(--card);padding:12px;margin-bottom:8px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line)}

    /* SKELETON */
    .skeleton{background:#1f2125;animation:pulse 1.5s infinite;border-radius:inherit;width:100%;height:100%}
    @keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}

    /* BOTTOM NAV */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,16,20,0.95);border-top:1px solid var(--line);padding:10px 20px 20px;display:flex;justify-content:space-around;backdrop-filter:blur(10px);z-index:20}
    .nav-item{color:var(--muted);font-size:10px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px}
    .nav-item.active{color:var(--accent)}
    .nav-item i{font-size:20px}

    /* SEARCH RESULTS AREA */
    #searchResultsArea { padding-top: 20px; }
    .search-header { padding: 0 20px 10px; font-size: 14px; color: var(--accent); font-weight: bold; }
  </style>
</head>
<body>

  <div class="header">
    <div class="user-profile">
      <img src="" class="avatar" id="userAvatar">
      <div>
        <div class="welcome-text">Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ‘‹</div>
        <div class="username-text" id="userName">Ú©Ø§Ø±Ø¨Ø±</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="icon-btn" id="btnSearch"><i class="bi bi-search"></i></div>
    </div>
  </div>

  <div class="search-wrap" id="searchWrap">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ ÙÛŒÙ„Ù… ÛŒØ§ Ø³Ø±ÛŒØ§Ù„...">
      <i class="bi bi-search search-ico"></i>
    </div>
  </div>

  <div id="pageHome" class="page active">
    
    <div id="homeDashboard" class="home-content">
      
      <div class="section-header">
        <div class="section-title">ÙÛŒÙ„Ù…â€ŒÙ‡Ø§ÛŒ ØªØ±Ù†Ø¯ ğŸ”¥</div>
      </div>
      <div class="scroll-container" id="trendMovieCont">
        <div class="movie-card-large"><div class="poster-container"><div class="skeleton"></div></div></div>
        <div class="movie-card-large"><div class="poster-container"><div class="skeleton"></div></div></div>
      </div>

      <div class="section-header">
        <div class="section-title">Ø¨Ø±ØªØ±ÛŒÙ† ÙÛŒÙ„Ù…â€ŒÙ‡Ø§ â­</div>
      </div>
      <div class="scroll-container" id="topMovieCont">
        <div class="movie-card-large"><div class="poster-container"><div class="skeleton"></div></div></div>
      </div>

      <div class="section-header">
        <div class="section-title">Ø³Ø±ÛŒØ§Ù„â€ŒÙ‡Ø§ÛŒ ØªØ±Ù†Ø¯ ğŸ”¥</div>
      </div>
      <div class="scroll-container" id="trendSeriesCont">
        <div class="movie-card-large"><div class="poster-container"><div class="skeleton"></div></div></div>
      </div>

      <div class="section-header">
        <div class="section-title">Ø¨Ø±ØªØ±ÛŒÙ† Ø³Ø±ÛŒØ§Ù„â€ŒÙ‡Ø§ â­</div>
      </div>
      <div class="scroll-container" id="topSeriesCont">
        <div class="movie-card-large"><div class="poster-container"><div class="skeleton"></div></div></div>
      </div>

      <div class="section-header" style="margin-top:30px">
        <div class="section-title">Ø¢Ø±Ø´ÛŒÙˆ Ú©Ø§Ù…Ù„ ğŸ“‚</div>
      </div>
      <div class="vertical-list" id="allContentCont"></div>
      
      <div style="padding:20px">
        <button class="btn" id="btnLoadMore">Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±</button>
      </div>
    </div>

    <div id="searchResultsArea" class="home-content hidden">
      <div class="search-header" id="searchStatusText">Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:</div>
      <div class="vertical-list" id="searchResultList"></div>
    </div>

  </div>

  <div id="pageDetail" class="page">
    <div class="detail-hero">
      <div class="detail-cover" id="dCover"></div>
      <div class="detail-info">
        <div class="d-title" id="dTitle"></div>
        <div class="d-overview" id="dOverview"></div>
        <div class="small-meta" id="dMeta"></div>
      </div>
    </div>
    <div class="tree-box" id="dTree"></div>
    <div style="height:100px"></div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="goHome()"><i class="bi bi-house"></i><span>Ø®Ø§Ù†Ù‡</span></div>
    <div class="nav-item" onclick="toggleSearch()"><i class="bi bi-search"></i><span>Ø¬Ø³ØªØ¬Ùˆ</span></div>
    <div class="nav-item" onclick="goBack()"><i class="bi bi-arrow-left"></i><span>Ø¨Ø±Ú¯Ø´Øª</span></div>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  tg.setHeaderColor('#0f1014');

  // Ø¢Ø¯Ø±Ø³ API Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ (Ø§Ú¯Ø± Ù„ÙˆÚ©Ø§Ù„ Ù‡Ø³ØªÛŒØ¯ Ù‡Ù…ÛŒÙ† Ø¨Ù…Ø§Ù†Ø¯)
  const urlParams = new URLSearchParams(window.location.search);
  const API_URL = urlParams.get('api') || "http://127.0.0.1:8000";

  // State
  let allPage = 1;
  let allLoading = false;
  let detailStack = [];

  // Setup User
  function setupUser() {
    let name = "Ú©Ø§Ø±Ø¨Ø±";
    let photo = "https://ui-avatars.com/api/?name=User&background=222&color=fff";
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      const u = tg.initDataUnsafe.user;
      name = u.first_name;
      if (u.photo_url) photo = u.photo_url;
    }
    document.getElementById('userName').innerText = name;
    document.getElementById('userAvatar').src = photo;
  }

  // --- Core Fetcher ---
  async function fetchData(endpoint, params={}) {
    const url = new URL(`${API_URL}${endpoint}`);
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
    try {
      const res = await fetch(url);
      return await res.json();
    } catch(e) {
      console.error("API Error", e);
      return null;
    }
  }

  // --- Rendering Helpers ---
  function createCard(item, isSmall=false) {
    if(isSmall) {
      return `
        <div class="movie-card-small" onclick="openDetail('${item.code}')">
          <img src="${item.poster}" class="small-poster" loading="lazy">
          <div class="small-info">
            <div class="small-title">${item.title}</div>
            <div class="small-meta">
               <span class="chip"><i class="bi bi-star-fill" style="color:#f1c40f"></i> ${item.vote}</span>
               <span class="chip">${item.year}</span>
            </div>
          </div>
        </div>`;
    } else {
      return `
        <div class="movie-card-large" onclick="openDetail('${item.code}')">
          <div class="poster-container">
            <img src="${item.poster}" class="poster-img" loading="lazy">
            <div class="card-rating"><i class="bi bi-star-fill"></i> ${item.vote}</div>
          </div>
          <div class="movie-title-scroll">${item.title}</div>
        </div>`;
    }
  }

  function renderList(containerId, items, isSmall=false, append=false) {
    const el = document.getElementById(containerId);
    if (!items || items.length === 0) {
      if(!append) el.innerHTML = '<div style="font-size:12px;color:gray;padding:10px">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
      return;
    }
    let html = items.map(i => createCard(i, isSmall)).join('');
    if(append) el.innerHTML += html;
    else el.innerHTML = html;
  }

  // --- Logic: Load Dashboard Sections ---
  async function loadDashboard() {
    // 1. Trending Movies (Popular + Movie)
    const trendM = await fetchData('/api/movies', { type: 'movie', sort: 'popular', limit: 6 });
    renderList('trendMovieCont', trendM?.items);

    // 2. Top Movies (Top + Movie)
    const topM = await fetchData('/api/movies', { type: 'movie', sort: 'top', limit: 6 });
    renderList('topMovieCont', topM?.items);

    // 3. Trending Series
    const trendS = await fetchData('/api/movies', { type: 'series', sort: 'popular', limit: 6 });
    renderList('trendSeriesCont', trendS?.items);

    // 4. Top Series
    const topS = await fetchData('/api/movies', { type: 'series', sort: 'top', limit: 6 });
    renderList('topSeriesCont', topS?.items);

    // 5. All Content
    loadMoreAll(true);
  }

  async function loadMoreAll(reset=false) {
    if(reset) { allPage = 1; document.getElementById('allContentCont').innerHTML = ''; }
    if(allLoading) return;
    
    allLoading = true;
    document.getElementById('btnLoadMore').innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
    
    const data = await fetchData('/api/movies', { page: allPage, limit: 10, sort: 'new' });
    
    if(data && data.items) {
      renderList('allContentCont', data.items, true, true);
      allPage++;
      if(allPage > data.total_pages) document.getElementById('btnLoadMore').style.display = 'none';
      else document.getElementById('btnLoadMore').innerText = "Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±";
    }
    allLoading = false;
  }

  document.getElementById('btnLoadMore').onclick = () => loadMoreAll();

  // --- Logic: Search ---
  let searchTimeout;
  function toggleSearch() {
    const wrap = document.getElementById('searchWrap');
    wrap.classList.toggle('show');
    if(wrap.classList.contains('show')) document.getElementById('searchInput').focus();
    else cancelSearch();
  }
  
  document.getElementById('btnSearch').onclick = toggleSearch;

  document.getElementById('searchInput').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const q = e.target.value.trim();
    if(!q) {
      cancelSearch();
      return;
    }
    searchTimeout = setTimeout(() => performSearch(q), 600);
  });

  async function performSearch(q) {
    // Hide Dashboard, Show Search Results
    document.getElementById('homeDashboard').classList.add('hidden');
    document.getElementById('searchResultsArea').classList.remove('hidden');
    document.getElementById('searchResultList').innerHTML = '<div class="skeleton" style="height:60px;margin-bottom:10px"></div>';
    document.getElementById('searchStatusText').innerText = `Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ: "${q}"`;

    const data = await fetchData('/api/movies', { q: q, limit: 20 });
    renderList('searchResultList', data?.items, true);
  }

  function cancelSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('homeDashboard').classList.remove('hidden');
    document.getElementById('searchResultsArea').classList.add('hidden');
  }

  // --- Logic: Detail Page ---
  async function openDetail(code) {
    document.getElementById('pageHome').classList.remove('active');
    document.getElementById('pageDetail').classList.add('active');
    window.scrollTo(0,0);
    
    // Skeleton load
    const dCover = document.getElementById('dCover');
    dCover.innerHTML = '<div class="skeleton"></div>';
    
    const content = await fetchData(`/api/content/${code}`);
    const tree = await fetchData(`/api/content/${code}/tree`);
    
    if(!content) return;

    dCover.innerHTML = `<img src="${content.poster}">`;
    document.getElementById('dTitle').innerText = content.title;
    document.getElementById('dOverview').innerText = content.overview || "ØªÙˆØ¶ÛŒØ­ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.";
    document.getElementById('dMeta').innerHTML = `
      <span class="chip"><i class="bi bi-star-fill" style="color:#f1c40f"></i> ${content.vote}</span>
      <span class="chip">${content.year}</span>
      <span class="chip">${content.type === 'movie' ? 'ÙÛŒÙ„Ù…' : 'Ø³Ø±ÛŒØ§Ù„'}</span>
    `;

    renderTree(tree.tree);
  }

  function renderTree(nodes) {
    const box = document.getElementById('dTree');
    box.innerHTML = '';
    if(!nodes || !nodes.length) { box.innerHTML = 'ÙØ§ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.'; return; }
    
    // Simple recursive visualizer handled by simple clicks for now
    // For simplicity in this edit, I'll just show root nodes. 
    // Implementing full folder navigation requires a stack logic similar to previous code.
    // Let's bring back a simple stack logic here:
    
    detailStack = [{nodes: nodes, title: 'Root'}];
    renderCurrentTreeLevel();
  }

  function renderCurrentTreeLevel() {
    const box = document.getElementById('dTree');
    box.innerHTML = '';
    const current = detailStack[detailStack.length-1];
    
    if(detailStack.length > 1) {
      box.innerHTML += `
        <div class="node" onclick="popTree()" style="background:#2a2d35">
           <div><i class="bi bi-arrow-return-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</div>
        </div>`;
    }

    current.nodes.forEach(n => {
      const isFolder = n.media_type === 'folder';
      const icon = isFolder ? 'bi-folder-fill' : 'bi-download';
      const div = document.createElement('div');
      div.className = 'node';
      div.innerHTML = `<div><i class="bi ${icon}" style="margin-left:8px;color:${isFolder?'#f1c40f':'#e11d48'}"></i> ${n.text}</div>`;
      div.onclick = () => {
        if(isFolder) {
           detailStack.push({nodes: n.children, title: n.text});
           renderCurrentTreeLevel();
        } else {
           tg.sendData(`GET:${n.id}`);
           tg.close();
        }
      };
      box.appendChild(div);
    });
  }

  window.popTree = function() {
    if(detailStack.length > 1) {
      detailStack.pop();
      renderCurrentTreeLevel();
    }
  }

  window.goBack = function() {
    if(document.getElementById('pageDetail').classList.contains('active')) {
      document.getElementById('pageDetail').classList.remove('active');
      document.getElementById('pageHome').classList.add('active');
    } else if(document.getElementById('searchWrap').classList.contains('show')) {
      toggleSearch();
    }
  }

  window.goHome = function() {
    cancelSearch();
    document.getElementById('pageDetail').classList.remove('active');
    document.getElementById('pageHome').classList.add('active');
    window.scrollTo(0,0);
  }

  // Start
  setupUser();
  loadDashboard();

</script>
</body>
</html>
